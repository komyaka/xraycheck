# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ README

name: Update Repository Stats

on:
  schedule:
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 00:00 UTC (03:00 MSK)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions

jobs:
  update-stats:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      repository-projects: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get repository statistics
        id: stats
        env:
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º PAT –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ fallback –Ω–∞ github.token
          # PAT –Ω—É–∂–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ —Ç—Ä–∞—Ñ–∏–∫–∞ (views/clones)
          GITHUB_TOKEN: ${{ secrets.REPO_STATS_TOKEN || github.token }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import urllib.request
          import urllib.error
          
          token = os.environ['GITHUB_TOKEN']
          repo = os.environ['GITHUB_REPOSITORY']
          
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          
          # –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞)
          repo_url = f'https://api.github.com/repos/{repo}'
          try:
              req = urllib.request.Request(repo_url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  repo_data = json.loads(response.read())
          except Exception as e:
              print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: {e}")
              repo_data = {}
          
          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
          views_14d = 0
          unique_visitors_14d = 0
          try:
              views_url = f'https://api.github.com/repos/{repo}/traffic/views'
              req = urllib.request.Request(views_url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  views_data = json.loads(response.read())
              views_14d = views_data.get('count', 0)
              unique_visitors_14d = views_data.get('uniques', 0)
          except urllib.error.HTTPError as e:
              if e.code == 403:
                  print("‚ö†Ô∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (403 Forbidden). –í–æ–∑–º–æ–∂–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
              else:
                  print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {e.code} {e.reason}")
          except Exception as e:
              print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {e}")
          
          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–ª–æ–Ω–æ–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
          clones_14d = 0
          unique_clones_14d = 0
          try:
              clones_url = f'https://api.github.com/repos/{repo}/traffic/clones'
              req = urllib.request.Request(clones_url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  clones_data = json.loads(response.read())
              clones_14d = clones_data.get('count', 0)
              unique_clones_14d = clones_data.get('uniques', 0)
          except urllib.error.HTTPError as e:
              if e.code == 403:
                  print("‚ö†Ô∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–æ–Ω–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (403 Forbidden). –í–æ–∑–º–æ–∂–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
              else:
                  print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–æ–Ω–æ–≤: {e.code} {e.reason}")
          except Exception as e:
              print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–æ–Ω–æ–≤: {e}")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã)
          stars = repo_data.get('stargazers_count', 0)
          forks = repo_data.get('forks_count', 0)
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
          def format_number(num):
              return f"{num:,}".replace(',', ' ')
          
          views_formatted = format_number(views_14d)
          visitors_formatted = format_number(unique_visitors_14d)
          clones_formatted = format_number(clones_14d)
          unique_clones_formatted = format_number(unique_clones_14d)
          stars_formatted = format_number(stars)
          forks_formatted = format_number(forks)
          
          # –í—ã–≤–æ–¥–∏–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö (—Ñ–æ—Ä–º–∞—Ç —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º - –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã)
          out = os.environ['GITHUB_OUTPUT']
          def write_output(name, value):
              f = open(out, 'a')
              f.write(f'{name}<<OUTPUT\n')
              f.write(value + '\n')
              f.write('OUTPUT\n')
              f.close()
          write_output('views', views_formatted)
          write_output('visitors', visitors_formatted)
          write_output('clones', clones_formatted)
          write_output('unique_clones', unique_clones_formatted)
          write_output('stars', stars_formatted)
          write_output('forks', forks_formatted)
          
          print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:")
          print(f"  –ü—Ä–æ—Å–º–æ—Ç—Ä—ã (14–î): {views_formatted}")
          print(f"  –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ (14–î): {visitors_formatted}")
          print(f"  –ö–ª–æ–Ω—ã (14–î): {clones_formatted}")
          print(f"  –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª–æ–Ω—ã (14–î): {unique_clones_formatted}")
          print(f"  –ó–≤—ë–∑–¥—ã: {stars_formatted}")
          print(f"  –§–æ—Ä–∫–∏: {forks_formatted}")
          PYTHON_SCRIPT

      - name: Update README with statistics
        run: |
          python3 << 'PYTHON_SCRIPT'
          import re
          import os
          
          # –ó–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞
          views = os.environ.get('VIEWS', '0')
          visitors = os.environ.get('VISITORS', '0')
          clones = os.environ.get('CLONES', '0')
          unique_clones = os.environ.get('UNIQUE_CLONES', '0')
          stars = os.environ.get('STARS', '0')
          forks = os.environ.get('FORKS', '0')
          
          # –ß–∏—Ç–∞–µ–º README
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∑–∞–º–µ–Ω—ã: \s+ –∏ \s* —É—á–∏—Ç—ã–≤–∞—é—Ç —Ä–∞–∑–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ README
          def make_replacer(value):
              def replacer(match):
                  return match.group(1) + value + match.group(2)
              return replacer
          
          replacements = [
              (r'(\| –ü—Ä–æ—Å–º–æ—Ç—Ä—ã \(14–î\)\s+\|\s*)[^\|]*(\|)', make_replacer(views)),
              (r'(\| –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ \(14–î\)\s+\|\s*)[^\|]*(\|)', make_replacer(visitors)),
              (r'(\| –ö–ª–æ–Ω—ã \(14–î\)\s+\|\s*)[^\|]*(\|)', make_replacer(clones)),
              (r'(\| –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª–æ–Ω—ã \(14–î\)\s+\|\s*)[^\|]*(\|)', make_replacer(unique_clones)),
              (r'(\| –ó–≤—ë–∑–¥—ã\s+\|\s*)[^\|]*(\|)', make_replacer(stars)),
              (r'(\| –§–æ—Ä–∫–∏\s+\|\s*)[^\|]*(\|)', make_replacer(forks)),
          ]
          
          # –ó–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
          for pattern, replacer in replacements:
              content = re.sub(pattern, replacer, content)
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("‚úÖ README –æ–±–Ω–æ–≤–ª–µ–Ω —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π")
          print(f"  –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: {views}")
          print(f"  –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏: {visitors}")
          print(f"  –ö–ª–æ–Ω—ã: {clones}")
          print(f"  –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª–æ–Ω—ã: {unique_clones}")
          print(f"  –ó–≤—ë–∑–¥—ã: {stars}")
          print(f"  –§–æ—Ä–∫–∏: {forks}")
          PYTHON_SCRIPT
        env:
          VIEWS: ${{ steps.stats.outputs.views }}
          VISITORS: ${{ steps.stats.outputs.visitors }}
          CLONES: ${{ steps.stats.outputs.clones }}
          UNIQUE_CLONES: ${{ steps.stats.outputs.unique_clones }}
          STARS: ${{ steps.stats.outputs.stars }}
          FORKS: ${{ steps.stats.outputs.forks }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet README.md; then
            git add README.md
            git commit -m "update repository statistics [automated]"
            git pull --rebase origin main
            git push origin main
            echo "‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞"
          else
            echo "‚ÑπÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –∫–æ–º–º–∏—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi
